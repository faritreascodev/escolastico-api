# version: "3.8"

services:
  #  TRAEFIK
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "8080:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - escolastico-network
    restart: unless-stopped

  #  API GATEWAY
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8000:8000"
    environment:
      - USUARIOS_SERVICE_URL=http://usuarios-service:5001
      - CURSOS_SERVICE_URL=http://cursos-service:5002
      - MATRICULAS_SERVICE_URL=http://matriculas-service:5003
      - CALIFICACIONES_SERVICE_URL=http://calificaciones-service:5004
      - ASISTENCIA_SERVICE_URL=http://asistencia-service:5005
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gateway.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api-gateway.entrypoints=web"
      - "traefik.http.services.api-gateway.loadbalancer.server.port=8000"
    networks:
      - escolastico-network
    depends_on:
      - usuarios-service
      - cursos-service
      - matriculas-service
      - calificaciones-service
      - asistencia-service
    restart: unless-stopped

  #  USUARIOS SERVICE
  usuarios-service:
    build: ./usuarios-service
    container_name: usuarios-service
    ports:
      - "5001:5001"
    environment:
      - PORT=5001
      - MONGODB_URI=mongodb://mongo-usuarios:27017/escolastico_usuarios_db
      - NODE_ENV=production
      - SERVICE_NAME=usuarios-service
    networks:
      - escolastico-network
    depends_on:
      - mongo-usuarios
    restart: unless-stopped

  mongo-usuarios:
    image: mongo:7.0
    container_name: mongo-usuarios
    ports:
      - "27017:27017"
    volumes:
      - usuarios-data:/data/db
    networks:
      - escolastico-network
    restart: unless-stopped

  #  CURSOS SERVICE
  cursos-service:
    build: ./cursos-service
    container_name: cursos-service
    ports:
      - "5002:5002"
    environment:
      - PORT=5002
      - MONGODB_URI=mongodb://mongo-cursos:27017/escolastico_cursos_db
      - NODE_ENV=production
      - SERVICE_NAME=cursos-service
    networks:
      - escolastico-network
    depends_on:
      - mongo-cursos
    restart: unless-stopped

  mongo-cursos:
    image: mongo:7.0
    container_name: mongo-cursos
    ports:
      - "27018:27017"
    volumes:
      - cursos-data:/data/db
    networks:
      - escolastico-network
    restart: unless-stopped

  #  MATRICULAS SERVICE
  matriculas-service:
    build: ./matriculas-service
    container_name: matriculas-service
    ports:
      - "5003:5003"
    environment:
      - PORT=5003
      - MONGODB_URI=mongodb://mongo-matriculas:27017/escolastico_matriculas_db
      - NODE_ENV=production
      - SERVICE_NAME=matriculas-service
    networks:
      - escolastico-network
    depends_on:
      - mongo-matriculas
    restart: unless-stopped

  mongo-matriculas:
    image: mongo:7.0
    container_name: mongo-matriculas
    ports:
      - "27019:27017"
    volumes:
      - matriculas-data:/data/db
    networks:
      - escolastico-network
    restart: unless-stopped

  #  CALIFICACIONES SERVICE
  calificaciones-service:
    build: ./calificaciones-service
    container_name: calificaciones-service
    ports:
      - "5004:5004"
    environment:
      - PORT=5004
      - MONGODB_URI=mongodb://mongo-calificaciones:27017/escolastico_calificaciones_db
      - NODE_ENV=production
      - SERVICE_NAME=calificaciones-service
    networks:
      - escolastico-network
    depends_on:
      - mongo-calificaciones
    restart: unless-stopped

  mongo-calificaciones:
    image: mongo:7.0
    container_name: mongo-calificaciones
    ports:
      - "27020:27017"
    volumes:
      - calificaciones-data:/data/db
    networks:
      - escolastico-network
    restart: unless-stopped

  #  ASISTENCIA SERVICE
  asistencia-service:
    build: ./asistencia-service
    container_name: asistencia-service
    ports:
      - "5005:5005"
    environment:
      - PORT=5005
      - MONGODB_URI=mongodb://mongo-asistencia:27017/escolastico_asistencia_db
      - NODE_ENV=production
      - SERVICE_NAME=asistencia-service
    networks:
      - escolastico-network
    depends_on:
      - mongo-asistencia
    restart: unless-stopped

  mongo-asistencia:
    image: mongo:7.0
    container_name: mongo-asistencia
    ports:
      - "27021:27017"
    volumes:
      - asistencia-data:/data/db
    networks:
      - escolastico-network
    restart: unless-stopped

volumes:
  usuarios-data:
  cursos-data:
  matriculas-data:
  calificaciones-data:
  asistencia-data:

networks:
  escolastico-network:
    driver: bridge
